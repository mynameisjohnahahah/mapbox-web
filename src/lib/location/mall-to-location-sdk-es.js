import t from"axios";import i from"dayjs";import{v4 as n}from"uuid";import o from"crypto-js/hmac-sha1";import e from"crypto-js/enc-base64";import{fromEvent as s,timer as a}from"rxjs";import{throttleTime as r,map as c,mergeMap as u,filter as l,switchMap as p}from"rxjs/operators";var h=function(){return(h=Object.assign||function(t){for(var i,n=1,o=arguments.length;n<o;n++)for(var e in i=arguments[n])Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e]);return t}).apply(this,arguments)};function d(t,a,r,c){return new(r=r||Promise)(function(n,i){function o(t){try{s(c.next(t))}catch(t){i(t)}}function e(t){try{s(c.throw(t))}catch(t){i(t)}}function s(t){var i;t.done?n(t.value):((i=t.value)instanceof r?i:new r(function(t){t(i)})).then(o,e)}s((c=c.apply(t,a||[])).next())})}function m(n,o){var e,s,a,r={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},t={next:i(0),throw:i(1),return:i(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function i(i){return function(t){return function(i){if(e)throw new TypeError("Generator is already executing.");for(;r;)try{if(e=1,s&&(a=2&i[0]?s.return:i[0]?s.throw||((a=s.return)&&a.call(s),0):s.next)&&!(a=a.call(s,i[1])).done)return a;switch(s=0,(i=a?[2&i[0],a.value]:i)[0]){case 0:case 1:a=i;break;case 4:return r.label++,{value:i[1],done:!1};case 5:r.label++,s=i[1],i=[0];continue;case 7:i=r.ops.pop(),r.trys.pop();continue;default:if(!((a=0<(a=r.trys).length&&a[a.length-1])||6!==i[0]&&2!==i[0])){r=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){r.label=i[1];break}if(6===i[0]&&r.label<a[1]){r.label=a[1],a=i;break}if(a&&r.label<a[2]){r.label=a[2],r.ops.push(i);break}a[2]&&r.ops.pop(),r.trys.pop();continue}i=o.call(n,r)}catch(t){i=[6,t],s=0}finally{e=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,t])}}}var f=function(){function s(t){this.host="",this.AppId=t.appId,this.AppSecret=t.appSecret,this.uuid=t.uuid,this.host=t.host||"https://test-easy.mall-to.com",this.init()}return s.prototype.init=function(){var i=this;t.interceptors.request.use(function(t){return t.baseURL=i.host,t.headers=Object.assign(t.headers,i.genHeader(Object.assign({},t.params||{},t.data||{}))),t},function(t){return Promise.reject(t)})},s.prototype.genHeader=function(t){var s=i().format("YYYY-MM-DD HH:mm:ss"),a=n(),r=this.AppId,c=this.uuid,u=h({timestamp:s,signature_nonce:a,app_id:r,uuid:c},t),l={};Object.keys(u).sort().forEach(function(t){l[t]=u[t]});t=Object.keys(l).map(function(t){return t+"="+l[t]}).join("&"),t=encodeURIComponent(t),t=o(t,this.AppSecret),t=e.stringify(t);return{Signature:encodeURIComponent(t),"App-Id":r,"Signature-Nonce":a,UUID:c,Timestamp:s,Accept:"application/json","Signature-Version":4}},s.prototype.getPosition=function(o){return void 0===o&&(o={openid:"omR735dF01pxo3SDxlS5SVDzcx_8"}),d(this,void 0,void 0,function(){var n;return m(this,function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,t.get("/api/lbs/asyn/location",{params:o})];case 1:return[2,i.sent().data];case 2:return n=i.sent(),console.error("定位失败: "+n.message||n),[2,void 0];case 3:return[2]}})})},s}(),b=self,v={filtered:new Array(10).fill(1),avg_filter:1,std_filter:0,timestamp:0},y=[],g=function(n){return new Promise(function(t){var i=new FileReader;i.readAsText(n,"utf-8"),i.onload=function(){t(JSON.parse(i.result))}})},Z=function(h){return new Promise(function(t){for(var i=h.acceleration,n=h.accelerationGravity,o=h.timestamp,e=0,s=0,a=0;a<3;a+=1){var r=i[a]-n[a];e+=r*i[a],s+=r*r}var c=e/Math.sqrt(s);y.push(c),10<y.length&&y.shift();var u,l,p=1<Math.max.apply(null,y);return 1==(u=c,l=1,v.filtered.shift(),Math.abs(u-v.avg_filter)>+v.std_filter?((u<=v.avg_filter||u<1)&&(l=-1),c=.1*u+.9*v.filtered[8],v.filtered.push(c)):(l=0,v.filtered.push(u)),v.avg_filter=v.filtered.reduce(function(t,i){return t+i},0)/10,v.std_filter=Math.sqrt(v.filtered.reduce(function(t,i){return t.concat(Math.pow(i-v.avg_filter,2))},[]).reduce(function(t,i){return t+i/10},0)),l)&&600<o-v.timestamp?(v.timestamp=o,t({walk:!0,motion:p})):t({walk:!1,motion:p})})};function W(s,t,i){var n=void 0===t?null:t,t=function(t){var i=atob(s);if(t){for(var n=new Uint8Array(i.length),o=0,e=i.length;o<e;++o)n[o]=i.charCodeAt(o);return String.fromCharCode.apply(null,new Uint16Array(n.buffer))}return i}(void 0!==i&&i),i=t.indexOf("\n",10)+1,n=t.substring(i)+(n?"//# sourceMappingURL="+n:""),n=new Blob([n],{type:"application/javascript"});return URL.createObjectURL(n)}b.addEventListener("message",function(e){return d(void 0,void 0,void 0,function(){var i,n,o;return m(this,function(t){switch(t.label){case 0:return o=e.data,[4,g(o)];case 1:return"motion"===(i=t.sent(),n=null,o.type)?[3,2]:[3,4];case 2:return[4,Z(i.data)];case 3:return n=t.sent(),[3,4];case 4:return n&&(n={id:i.id,data:n},o=new Blob([JSON.stringify(n)],{type:o.type}),b.postMessage(o)),[2]}})})});var S,w,X,k,G=(w=null,X=!(S="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwp2YXIgd29ya2VyX2NvZGU9ZnVuY3Rpb24oZSl7InVzZSBzdHJpY3QiO2Z1bmN0aW9uIGQocil7cmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKGUpe3ZhciB0PW5ldyBGaWxlUmVhZGVyO3QucmVhZEFzVGV4dChyLCJ1dGYtOCIpLHQub25sb2FkPWZ1bmN0aW9uKCl7ZShKU09OLnBhcnNlKHQucmVzdWx0KSl9fSl9ZnVuY3Rpb24gcChkKXtyZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24oZSl7Zm9yKHZhciB0PWQuYWNjZWxlcmF0aW9uLHI9ZC5hY2NlbGVyYXRpb25HcmF2aXR5LG49ZC50aW1lc3RhbXAsYT0wLGk9MCxvPTA7bzwzO28rPTEpe3ZhciBsPXRbb10tcltvXTthKz1sKnRbb10saSs9bCpsfXZhciB1PWEvTWF0aC5zcXJ0KGkpO3kucHVzaCh1KSwxMDx5Lmxlbmd0aCYmeS5zaGlmdCgpO3ZhciBzLGMsZj0xPE1hdGgubWF4LmFwcGx5KG51bGwseSk7cmV0dXJuIDE9PShzPXUsYz0xLHYuZmlsdGVyZWQuc2hpZnQoKSxNYXRoLmFicyhzLXYuYXZnX2ZpbHRlcik+K3Yuc3RkX2ZpbHRlcj8oKHM8PXYuYXZnX2ZpbHRlcnx8czwxKSYmKGM9LTEpLHU9LjEqcysuOSp2LmZpbHRlcmVkWzhdLHYuZmlsdGVyZWQucHVzaCh1KSk6KGM9MCx2LmZpbHRlcmVkLnB1c2gocykpLHYuYXZnX2ZpbHRlcj12LmZpbHRlcmVkLnJlZHVjZShmdW5jdGlvbihlLHQpe3JldHVybiBlK3R9LDApLzEwLHYuc3RkX2ZpbHRlcj1NYXRoLnNxcnQodi5maWx0ZXJlZC5yZWR1Y2UoZnVuY3Rpb24oZSx0KXtyZXR1cm4gZS5jb25jYXQoTWF0aC5wb3codC12LmF2Z19maWx0ZXIsMikpfSxbXSkucmVkdWNlKGZ1bmN0aW9uKGUsdCl7cmV0dXJuIGUrdC8xMH0sMCkpLGMpJiY2MDA8bi12LnRpbWVzdGFtcD8odi50aW1lc3RhbXA9bixlKHt3YWxrOiEwLG1vdGlvbjpmfSkpOmUoe3dhbGs6ITEsbW90aW9uOmZ9KX0pfXZhciBoPXNlbGYsdj17ZmlsdGVyZWQ6bmV3IEFycmF5KDEwKS5maWxsKDEpLGF2Z19maWx0ZXI6MSxzdGRfZmlsdGVyOjAsdGltZXN0YW1wOjB9LHk9W107cmV0dXJuIGguYWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsZnVuY3Rpb24oZil7cmV0dXJuIHU9ZnVuY3Rpb24oKXt2YXIgdCxyLG4sYSxpLG8sbCx1LHMsZTtyZXR1cm4gYT10aGlzLGk9ZnVuY3Rpb24oZSl7c3dpdGNoKGUubGFiZWwpe2Nhc2UgMDpyZXR1cm4gbj1mLmRhdGEsWzQsZChuKV07Y2FzZSAxOnJldHVybiJtb3Rpb24iPT09KHQ9ZS5zZW50KCkscj1udWxsLG4udHlwZSk/WzMsMl06WzMsNF07Y2FzZSAyOnJldHVybls0LHAodC5kYXRhKV07Y2FzZSAzOnJldHVybiByPWUuc2VudCgpLFszLDRdO2Nhc2UgNDpyZXR1cm4gciYmKHI9e2lkOnQuaWQsZGF0YTpyfSxuPW5ldyBCbG9iKFtKU09OLnN0cmluZ2lmeShyKV0se3R5cGU6bi50eXBlfSksaC5wb3N0TWVzc2FnZShuKSksWzJdfX0scz17bGFiZWw6MCxzZW50OmZ1bmN0aW9uKCl7aWYoMSZ1WzBdKXRocm93IHVbMV07cmV0dXJuIHVbMV19LHRyeXM6W10sb3BzOltdfSxlPXtuZXh0OmMoMCksdGhyb3c6YygxKSxyZXR1cm46YygyKX0sImZ1bmN0aW9uIj09dHlwZW9mIFN5bWJvbCYmKGVbU3ltYm9sLml0ZXJhdG9yXT1mdW5jdGlvbigpe3JldHVybiB0aGlzfSksZTtmdW5jdGlvbiBjKHQpe3JldHVybiBmdW5jdGlvbihlKXtyZXR1cm4gZnVuY3Rpb24odCl7aWYobyl0aHJvdyBuZXcgVHlwZUVycm9yKCJHZW5lcmF0b3IgaXMgYWxyZWFkeSBleGVjdXRpbmcuIik7Zm9yKDtzOyl0cnl7aWYobz0xLGwmJih1PTImdFswXT9sLnJldHVybjp0WzBdP2wudGhyb3d8fCgodT1sLnJldHVybikmJnUuY2FsbChsKSwwKTpsLm5leHQpJiYhKHU9dS5jYWxsKGwsdFsxXSkpLmRvbmUpcmV0dXJuIHU7c3dpdGNoKGw9MCwodD11P1syJnRbMF0sdS52YWx1ZV06dClbMF0pe2Nhc2UgMDpjYXNlIDE6dT10O2JyZWFrO2Nhc2UgNDpyZXR1cm4gcy5sYWJlbCsrLHt2YWx1ZTp0WzFdLGRvbmU6ITF9O2Nhc2UgNTpzLmxhYmVsKyssbD10WzFdLHQ9WzBdO2NvbnRpbnVlO2Nhc2UgNzp0PXMub3BzLnBvcCgpLHMudHJ5cy5wb3AoKTtjb250aW51ZTtkZWZhdWx0OmlmKCEoKHU9MDwodT1zLnRyeXMpLmxlbmd0aCYmdVt1Lmxlbmd0aC0xXSl8fDYhPT10WzBdJiYyIT09dFswXSkpe3M9MDtjb250aW51ZX1pZigzPT09dFswXSYmKCF1fHx0WzFdPnVbMF0mJnRbMV08dVszXSkpe3MubGFiZWw9dFsxXTticmVha31pZig2PT09dFswXSYmcy5sYWJlbDx1WzFdKXtzLmxhYmVsPXVbMV0sdT10O2JyZWFrfWlmKHUmJnMubGFiZWw8dVsyXSl7cy5sYWJlbD11WzJdLHMub3BzLnB1c2godCk7YnJlYWt9dVsyXSYmcy5vcHMucG9wKCkscy50cnlzLnBvcCgpO2NvbnRpbnVlfXQ9aS5jYWxsKGEscyl9Y2F0Y2goZSl7dD1bNixlXSxsPTB9ZmluYWxseXtvPXU9MH1pZig1JnRbMF0pdGhyb3cgdFsxXTtyZXR1cm57dmFsdWU6dFswXT90WzFdOnZvaWQgMCxkb25lOiEwfX0oW3QsZV0pfX19LG5ldyhsPShsPW89ZT12b2lkIDApfHxQcm9taXNlKShmdW5jdGlvbihyLHQpe2Z1bmN0aW9uIG4oZSl7dHJ5e2kodS5uZXh0KGUpKX1jYXRjaChlKXt0KGUpfX1mdW5jdGlvbiBhKGUpe3RyeXtpKHUudGhyb3coZSkpfWNhdGNoKGUpe3QoZSl9fWZ1bmN0aW9uIGkoZSl7dmFyIHQ7ZS5kb25lP3IoZS52YWx1ZSk6KCh0PWUudmFsdWUpaW5zdGFuY2VvZiBsP3Q6bmV3IGwoZnVuY3Rpb24oZSl7ZSh0KX0pKS50aGVuKG4sYSl9aSgodT11LmFwcGx5KGUsb3x8W10pKS5uZXh0KCkpfSk7dmFyIGUsbyxsLHV9KSxlLk1vdGlvblNlbnNvcj1wLGUuYW5hbHlzaXM9ZCxlfSh7fSk7Cgo="),function(t){return k=k||W(S,w,X),new Worker(k,t)});function M(t){var i=20037508.34*t[0]/180,t=Math.log(Math.tan((90+t[1])*Math.PI/360))/(Math.PI/180);return[i,t*=20037508.34/180]}function Y(t){var i=t[0]/20037508.34*180,t=t[1]/20037508.34*180;return[i,t=180/Math.PI*(2*Math.atan(Math.exp(t*Math.PI/180))-Math.PI/2)]}var P=function(){function t(){this.worker=new G,this.worker.onmessage=this.onMessage.bind(this),this.tasks=[]}return t.prototype.addTask=function(o,e){var s=this;return new Promise(function(t,i){var n={id:(new Date).getTime().toString(),data:e};s.tasks[n.id]=[t,i];n=new Blob([JSON.stringify(n)],{type:o});s.worker.postMessage(n)})},t.prototype.onMessage=function(t){var n,o=this;n=t.data,new Promise(function(t){var i=new FileReader;i.readAsText(n,"utf-8"),i.onload=function(){t(JSON.parse(i.result))}}).then(function(t){var i=o.tasks[t.id],n=i[0],i=i[1];0<Object.keys(t.data).length?n(t.data):i("not content"),delete o.tasks[t.id]})},t}(),R=function(){function t(t){var i=this;console.log("方向传感器"+(t?"关闭":"开启")+"了web-worker"),t||(this.worker=new P),this.source=s(window,"devicemotion").pipe(r(100),c(function(t){var i=t.acceleration,t=t.accelerationIncludingGravity;return i&&t?{acceleration:[i.x||0,i.y||0,i.z||0],accelerationGravity:[t.x||0,t.y||0,t.z||0],timestamp:(new Date).getTime()}:{acceleration:[0,0,0],accelerationGravity:[0,0,0],timestamp:(new Date).getTime()}}),u(function(t){return i.worker?i.worker.addTask("motion",t):Z(t)}))}return t.prototype.listener=function(t){this.subMotionEngine=this.source.subscribe(t)},t.prototype.complete=function(){var t;null===(t=this.subMotionEngine)||void 0===t||t.unsubscribe()},t}(),L=function(){function t(){var e=this;this.LOW_ALPHA=.23;var t="IOS"==(/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)?"IOS":"Android")?"deviceorientation":"deviceorientationabsolute";this.source=s(window,t).pipe(r(100),c(function(t){var i=t.beta,n=t.gamma,o=t.alpha,t=t.webkitCompassHeading;return!(i&&n&&o)||60<Math.abs(i)||60<Math.abs(n)?1e3:e.smooth(t||360-o)}),l(function(t){return t<=360}))}return t.prototype.smooth=function(t){var i=t*Math.PI/180,t=Math.sin(i),i=Math.cos(i);this.smoothData?(t=.6*this.smoothData.sin+.4*t,i=.6*this.smoothData.cos+.4*i):this.smoothData={sin:t,cos:i};i=180*Math.atan2(t,i)/Math.PI;return i<0&&(i+=360),i},t.prototype.listener=function(t){this.subOrientationEngine=this.source.subscribe(t)},t.prototype.complete=function(){var t;null===(t=this.subOrientationEngine)||void 0===t||t.unsubscribe()},t}(),V=function(){function t(t){void 0===t&&(t={}),this.stepLong=.5,this.status=!1,this.options=t}return t.prototype.authDevicePermission=function(){return d(this,void 0,void 0,function(){var i;return m(this,function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?[4,DeviceOrientationEvent.requestPermission()]:[3,2];case 1:return"granted"===t.sent()?(console.log("设备已授权动作和方向传感器"),this.status=!0,this.initEngine(),[2,{success:!0,msg:"设备已授权动作和方向传感器"}]):(console.error("授权失败: 设备未授权动作和方向传感器"),[2,{success:this.status=!1,msg:"授权失败: 设备未授权动作和方向传感器"}]);case 2:return this.status=!1,console.error("授权失败: 此浏览器没有动作和方向传感器的API, 惯导无法开启"),[2,{success:!1,msg:"授权失败: 此浏览器没有动作和方向传感器的API, 惯导无法开启"}];case 3:return i=t.sent(),this.status=!1,console.error("此浏览器没有动作和方向传感器的API, 惯导无法开启: \t",i),[2,{success:!1,msg:"授权失败: 惯导无法开启"}];case 4:return[2]}})})},t.prototype.initEngine=function(){var t;this.status&&(t=!1===this.options.openWorker,this.motionEngine=new R(t),this.orientationEngine=new L)},t.prototype.updateLocationData=function(t){this.locationData=JSON.parse(JSON.stringify(t))},t.prototype.updatePositionData=function(t){this.position=JSON.parse(JSON.stringify(t))},t.prototype.startMotionEngine=function(n){var t,o=this;this.status?null===(t=this.motionEngine)||void 0===t||t.listener(function(t){var i;if(o.motionState=t,null!==(t=o.locationData)&&void 0!==t&&t.position){if(!(i=o.computeMotionPosition(o.locationData.position)))return void console.warn("如果需要使用惯导, 请先使用'setPosition'设置的经纬度或者打开定位SDK服务");o.locationData.position=i,n("motion",{success:!0,data:o.locationData,msg:"惯性导航更新位置成功"})}o.position&&((i=o.computeMotionPosition(o.position))?(o.position=i,n("motion",{success:!0,data:o.position,msg:"惯性导航更新位置成功"})):console.warn("如果需要使用惯导, 请先使用'setPosition'设置的经纬度或者打开定位SDK服务"))}):n("error",{msg:"设备未授权动作和方向传感器",success:!1})},t.prototype.computeMotionPosition=function(t){if(null!==(i=this.motionState)&&void 0!==i&&i.walk&&this.orientationData){if(!t)return!1;var i=M(t),t=this.orientationData*Math.PI/180;return Y([i[0]+this.stepLong*Math.sin(t),i[1]+this.stepLong*Math.cos(t)])}return!1},t.prototype.startOrientationEngine=function(i){var t,n=this;this.status?null===(t=this.orientationEngine)||void 0===t||t.listener(function(t){n.orientationData=t,i("orientation",{msg:"方向传感器更新",data:t,success:!1})}):i("error",{msg:"设备未授权动作和方向传感器",success:!1})},t.prototype.endEngine=function(){var t;null===(t=this.orientationEngine)||void 0===t||t.complete(),null===(t=this.motionEngine)||void 0===t||t.complete()},t}(),x=function(){function t(){this._Q=.01,this._R=.08,this._PX=.1,this._PY=.1}return t.prototype.forecast=function(t,i,n){var o=i/(i+this._R);return[t+o*(n-t),(1-o)*i]},Object.defineProperty(t.prototype,"observations",{get:function(){return this._observations},set:function(t){this._observations=t},enumerable:!1,configurable:!0}),t.prototype.update=function(t){if(!this._observations)return t;this._PX=this._PX+this._Q,this._PY=this._PY+this._Q;var i=this.forecast(t[0],this._PX,this._observations[0]),n=i[0],o=i[1],i=this.forecast(t[1],this._PY,this._observations[1]),t=i[0],i=i[1];return this._PX=o,this._PY=i,[n,t]},t.prototype.reset=function(){this._PX=.1,this._PY=.1},t}(),K=function(){function t(t){this.options=t||{},this.kalman=new x;var i=t.openInertialNavigation,i=void 0!==i&&i;this.delayWalkStatus=!0,this.delayWalkTime=1e4,this.startClearWalkStatus(),this.service=new f(t),i&&this.startInertialNavigation().then().catch(function(t){return console.error(t)})}return t.prototype.getDistance=function(t,i,n,o){function e(t){return t*Math.PI/180}t=e(t),n=e(n),o=e(i)-e(o),o=2*Math.asin(Math.sqrt(Math.pow(Math.sin((t-n)/2),2)+Math.cos(t)*Math.cos(n)*Math.pow(Math.sin(o/2),2)));return o*=6378.137,Math.round(1e4*o)/1e4},t.prototype.startClearWalkStatus=function(t){var i=this;void 0===t&&(t=this.delayWalkTime),this.delayWalkStatus=!0,clearTimeout(this.ClearWalkStatusTimer),this.ClearWalkStatusTimer=setTimeout(function(){var t;null!==(t=null===(t=i.inertialNavigation)||void 0===t?void 0:t.motionState)&&void 0!==t&&t.walk&&(i.delayWalkStatus=!1)},t)},t.prototype.kalmanCompute=function(t){var i={floor_id:t.floor_id,block_id:t.block_id,position:t.smooth||t.stable||t.position};return this.locationRawData&&(i.floor_id!==this.locationRawData.floor_id&&this.kalman.reset(),this.kalman.observations=M(i.position),t=this.kalman.update(M(this.locationRawData.position)),i.position=Y(t),null!==(t=this.locationRawData)&&void 0!==t&&t.position&&(this.locationRawData.position=i.position)),{success:!0,data:this.location=i,msg:"定位成功"}},t.prototype.getPositionData=function(e,s){var a;return d(this,void 0,void 0,function(){var i,n,o;return m(this,function(t){switch(t.label){case 0:return n=(i=s||{}).delayStopTime,n=void 0===n?1e4:n,i=void 0===(i=i.stopWalkingRefreshRange)?2:i,this.delayWalkTime=n,[4,this.service.getPosition(e)];case 1:return(n=t.sent())?(this.locationRawData=n,null!==(a=this.inertialNavigation)&&void 0!==a&&a.status&&this.locationRawData&&this.location&&(o=this.getDistance(this.location.position[0],this.location.position[1],n.position[0],n.position[1]))<i&&!this.delayWalkStatus?(console.warn('停止移动后更新位置的范围可以通过"stopWalkingRefreshRange"设置'),[2,{success:!1,msg:"位置本次更新"+o+"米, 但是人物已经停止移动且没有触发更新位置的范围"+i+"米"}]):[2,this.kalmanCompute(n)]):[2,{success:!1,msg:"定位中, 请查看控制台报错"}]}})})},t.prototype.onPosition=function(t,i,n){var o=this,e=(i=void 0===i?{}:i).delay,s=void 0===e?0:e,r=i.interval,e=void 0===r?1e3:r,r=i.delayStopTime,c=void 0===r?1e4:r,i=i.stopWalkingRefreshRange,u=void 0===i?2:i;this.onPositionCallback=n,this.subPosition=a(s,e).pipe(p(function(){return o.getPositionData(t,{delayStopTime:c,stopWalkingRefreshRange:u})})).subscribe(function(t){var i;t.success&&t.data&&(null===(i=o.inertialNavigation)||void 0===i||i.updateLocationData(t.data)),n&&n(t)})},t.prototype.stopPosition=function(){this.subPosition&&this.subPosition.unsubscribe()},t.prototype.setPosition=function(t){if(!this.inertialNavigation)return{success:!1,msg:"请先打开惯导服务"};this.inertialNavigation.updatePositionData(t)},t.prototype.startInertialNavigation=function(){return d(this,void 0,void 0,function(){return m(this,function(t){switch(t.label){case 0:return this.inertialNavigation?[3,2]:(this.inertialNavigation=new V(this.options.inertialNavigationOptions),[4,this.inertialNavigation.authDevicePermission()]);case 1:return[2,t.sent()];case 2:return this.inertialNavigation.status?[2,{success:!0,msg:"惯导服务已经开启了"}]:[2,{success:!1,msg:"动作和方向授权未打开"}];case 3:return[2]}})})},t.prototype.onInertialNavigation=function(n){var t,o=this;null===(t=this.inertialNavigation)||void 0===t||t.startMotionEngine(function(t,i){"motion"===t&&(o.startClearWalkStatus(),o.onPositionCallback&&o.onPositionCallback({data:i.data,msg:i.msg,success:!0}),n("motion",i))}),null===(t=this.inertialNavigation)||void 0===t||t.startOrientationEngine(n)},t.prototype.stopInertialNavigation=function(){var t;null===(t=this.inertialNavigation)||void 0===t||t.endEngine()},t}();export default K;
